name: Frontend CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# --------------------------------
# REQUIRED for Trivy SARIF upload
# --------------------------------
permissions:
  contents: read
  security-events: write

env:
  AWS_REGION: eu-north-1
  AWS_ACCOUNT_ID: "024955634588"
  GITOPS_REPO: "WSO2-G02/salon-gitops"
  FRONTEND_SERVICE_NAME: "salon-frontend"

# ======================================================================
# TEST JOB
# ======================================================================
jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Run tests
        run: |
          if jq -e '.scripts.test' package.json > /dev/null; then
            npm run test || true
          else
            echo "No test script found."
          fi

# ======================================================================
# BUILD JOB
# ======================================================================
  build:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: [ test ]
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      full_image: ${{ steps.meta.outputs.full_image }}
      ecr_registry: ${{ steps.meta.outputs.ecr_registry }}

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          TIMESTAMP=$(date +'%Y%m%d%H%M%S')
          ECR_REGISTRY=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

          IMAGE_TAG="${SHORT_SHA}-${TIMESTAMP}"
          FULL_IMAGE="${ECR_REGISTRY}/${FRONTEND_SERVICE_NAME}:${IMAGE_TAG}"

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "ecr_registry=${ECR_REGISTRY}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image (load locally)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: |
            ${{ steps.meta.outputs.full_image }}
          build-args: |
            NEXT_PUBLIC_USER_API_BASE=${{ secrets.NEXT_PUBLIC_USER_API_BASE }}
            NEXT_PUBLIC_SERVICE_API_BASE=${{ secrets.NEXT_PUBLIC_SERVICE_API_BASE }}
            NEXT_PUBLIC_STAFF_API_BASE=${{ secrets.NEXT_PUBLIC_STAFF_API_BASE }}
            NEXT_PUBLIC_APPOINTMENT_API_BASE=${{ secrets.NEXT_PUBLIC_APPOINTMENT_API_BASE }}
            NEXT_PUBLIC_NOTIFICATION_API_BASE=${{ secrets.NEXT_PUBLIC_NOTIFICATION_API_BASE }}
            NEXT_PUBLIC_ANALYTICS_API_BASE=${{ secrets.NEXT_PUBLIC_ANALYTICS_API_BASE }}

      - name: Save image artifact
        run: |
          docker save ${{ steps.meta.outputs.full_image }} | gzip > image-frontend.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: image-frontend
          path: image-frontend.tar.gz
          retention-days: 1

# ======================================================================
# TRIVY SCAN JOB
# ======================================================================
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    needs: [ build ]
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: image-frontend

      - name: Load image
        id: load
        run: |
          gunzip -c image-frontend.tar.gz | docker load
          IMAGE_ID=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep "${FRONTEND_SERVICE_NAME}" | head -n1)
          echo "image_ref=$IMAGE_ID" >> $GITHUB_OUTPUT

      - name: Run Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.load.outputs.image_ref }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
          cache: true
          exit-code: "1"

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy-frontend"

# ======================================================================
# PUSH TO ECR (ONLY IF TRIVY PASSES)
# ======================================================================
  push-to-ecr:
    name: Push Image to ECR
    runs-on: ubuntu-latest
    needs: [ trivy-scan ]
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       github.base_ref == 'main')

    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - uses: actions/download-artifact@v4
        with:
          name: image-frontend

      - name: Load + Push image
        run: |
          gunzip -c image-frontend.tar.gz | docker load
          FULL_IMAGE="${{ needs.build.outputs.full_image }}"
          LATEST="${{ needs.build.outputs.ecr_registry }}/${FRONTEND_SERVICE_NAME}:latest"

          docker push "$FULL_IMAGE"
          docker tag "$FULL_IMAGE" "$LATEST"
          docker push "$LATEST"

# ======================================================================
# UPDATE GITOPS (ARGOCD DEPLOYS LATEST IMAGE)
# ======================================================================
  update-gitops:
    name: Update GitOps Manifests
    runs-on: ubuntu-latest
    needs: [ push-to-ecr ]
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       github.base_ref == 'main')

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops

      - name: Patch deployment file
        run: |
          cd gitops
          DEPLOY=staging/${FRONTEND_SERVICE_NAME}/deployment.yaml
          ECR=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
          TAG=${{ needs.build.outputs.image_tag }}

          sed -i "s|image: .*${FRONTEND_SERVICE_NAME}:.*|image: ${ECR}/${FRONTEND_SERVICE_NAME}:${TAG}|g" "$DEPLOY"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$DEPLOY"
          git commit -m "Update frontend image -> ${TAG}" || true
          git push
