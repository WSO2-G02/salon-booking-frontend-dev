name: Deploy Frontend to Production

# NOTE: For deploying multiple services at once, use the unified workflow:
# https://github.com/WSO2-G02/salon-gitops/actions/workflows/deploy-production.yml

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (leave empty to promote from staging)'
        required: false
        type: string
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: '024955634588.dkr.ecr.us-east-1.amazonaws.com'
  GITOPS_REPO: 'WSO2-G02/salon-gitops'
  SERVICE_NAME: 'frontend'

jobs:
  validate:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_tag.outputs.image_tag }}
    steps:
      - name: Verify confirmation
        if: ${{ github.event.inputs.confirm_deployment != 'DEPLOY' }}
        run: |
          echo "[ERROR] Deployment not confirmed. Please type DEPLOY to confirm."
          exit 1

      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops

      - name: Get image tag to deploy
        id: get_tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
            echo "Using provided image tag: $IMAGE_TAG"
          else
            # Get current staging image tag
            STAGING_FILE="gitops/staging/${{ env.SERVICE_NAME }}/deployment.yaml"
            IMAGE_TAG=$(grep "image:" "$STAGING_FILE" | head -1 | awk -F: '{print $NF}' | tr -d ' ')
            echo "Promoting staging image tag: $IMAGE_TAG"
          fi
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Validate image exists in ECR
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          pip install awscli --quiet
          
          IMAGE_TAG="${{ steps.get_tag.outputs.image_tag }}"
          
          aws ecr describe-images \
            --repository-name ${{ env.SERVICE_NAME }} \
            --image-ids imageTag=$IMAGE_TAG \
            --region ${{ env.AWS_REGION }} || {
              echo "::error::Image tag $IMAGE_TAG not found in ECR!"
              exit 1
            }
          
          echo "Image verified: ${{ env.ECR_REGISTRY }}/${{ env.SERVICE_NAME }}:$IMAGE_TAG"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate]
    environment: production  # Requires approval if configured
    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops

      - name: Update production deployment
        env:
          IMAGE_TAG: ${{ needs.validate.outputs.image_tag }}
        run: |
          cd gitops
          
          PROD_FILE="production/${{ env.SERVICE_NAME }}/deployment.yaml"
          
          if [ -f "$PROD_FILE" ]; then
            CURRENT_TAG=$(grep "image:" "$PROD_FILE" | head -1 | awk -F: '{print $NF}' | tr -d ' ')
            echo "Current production tag: $CURRENT_TAG"
            echo "New production tag: $IMAGE_TAG"
            
            sed -i "s|image: ${{ env.ECR_REGISTRY }}/${{ env.SERVICE_NAME }}:.*|image: ${{ env.ECR_REGISTRY }}/${{ env.SERVICE_NAME }}:${IMAGE_TAG}|g" "$PROD_FILE"
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$PROD_FILE"
            git commit -m "[PROD] Deploy ${{ env.SERVICE_NAME }}:${IMAGE_TAG}

Deployed by: ${{ github.actor }}
Previous: $CURRENT_TAG"
            git push
            
            echo "Production deployment manifest updated!"
          else
            echo "::error::Production deployment file not found: $PROD_FILE"
            exit 1
          fi

      - name: Create deployment summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ needs.validate.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed By** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | Production |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. ArgoCD will auto-sync within 3 minutes" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify at: https://aurora-glam.com" >> $GITHUB_STEP_SUMMARY
          echo "3. Check ArgoCD: https://argocd.aurora-glam.com" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: always()
    steps:
      - name: Notify success
        if: needs.deploy.result == 'success'
        run: |
          echo "[SUCCESS] Production deployment successful!"
          echo "Image: ${{ needs.validate.outputs.image_tag }}"
          # Add Slack/Discord notification here if needed
          
      - name: Notify failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "[FAILED] Production deployment failed!"
          echo "Please check the workflow logs."
          # Add Slack/Discord notification here if needed
